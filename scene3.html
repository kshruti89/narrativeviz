<!DOCTYPE html>
<html lang="en-us">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <head>
    <meta charset="UTF-8" />
    <title>Narrative visualization by Shruti Kalia (kshruti89)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/normalize.css"
      media="screen"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:200,500"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/stylesheet.css"
      media="screen"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/github-light.css"
      media="screen"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/custom.css"
      media="screen"
    />
  </head>

  <body onload="init()">
    <section class="page-header1">
      <h1 class="project-name">Summer Olympics 1976-2008</h1>
    </section>
    <div class="w3-bar w3-teal">
      <a
        href="#"
        onclick="navigate('previous');"
        class="w3-bar-item w3-button"
        style="width: 27%;"
        ><<</a
      >
      <a
        href="#"
        onclick="navigate('summary');"
        class="w3-bar-item w3-button"
        style="width: 15%;"
        >Summary</a
      >
      <a
        href="#"
        onclick="navigate('medalsby');"
        class="w3-bar-item w3-button"
        style="width: 15%;"
        >Medals By</a
      >
      <a
        href="#"
        onclick="navigate('medalsdetail');"
        class="w3-bar-item w3-button w3-green"
        style="width: 15%;"
        >Medals Detail</a
      >
      <a
        href="#"
        onclick="navigate('next');"
        class="w3-bar-item w3-button"
        style="width: 28%;"
        >>></a
      >
    </div>
    <section class="main-content">
      <h3>
        <span aria-hidden="true" class="octicon octicon-link"></span>Medal Type by Year
      </h3>
      <div class="tooltip1">
        <p>
		This chart shows medals by Gold/Silver/Bronze. By <mark class="teal">default</mark> shows 
        <mark class="teal">All Medals</mark> won by Countries in<mark class="teal"> All Sports</mark>.
        Chart is in ascending order with the Medal Types shown from 1976 to 1980 and so on.
		</p>
        If a Country has won any of the Medals: Gold, Silver or Bronze for all 4 consecutive years, then the page would display the medal count
		for respective Medal Categories from 1976 to 2008 in two pages. Or else, it would not display the year it has not won or not played.
		<p>
		Since most of the top 10 countries have won atleast one medal in every four years, hence different
		pages are used and hence the pagination.
		</p>
		<p>
        Any selection of a <mark class="teal">Game Type</mark> and <mark class="teal">Country</mark> from the previous page (i.e., first Chart) will set this chart accordingly.</br>
        Chart can be viewed interactively by selecting/deselecting the <mark class="teal">Medal Type of Gold, Silver or Bronze </mark> from the top right corner.
		</p>
        <div id="selectchoice">
          <div id="selectdiv"></div>
        </div>      
        <div> 
          <label id="chartlabel" for="chartlabel"></label>
        </div>
        <div id="pagination">
          <input type="button" id="first" onclick="firstPage()" value="first" />
          <input type="button" id="next" onclick="nextPage()" value="next" />
          <input type="button" id="previous" onclick="previousPage()" value="previous" />
          <input type="button" id="last" onclick="lastPage()" value="last" />
          <label id="paginationlabel" for="paginationlabel"></label>
        </div>        
        <svg id="chart" width="800" height="500"></svg>        
      </div>

      <footer class="site-footer">
        <div class="tooltip2">
        <mark class="teal">Previous[<<]</mark> or <mark class="teal">Next[>>]</mark> buttons on the menu bar help to navigate and view author set charts.
        </br>
        <span class="site-footer-credits">
        Alternatively, clicking on the chart provides interactivity to view corresponsing data on the charts.
        </span>
        </div>
      </footer>
    </section>

    <script>
      //Global Variable
      var filedata; // this one holds csv data
      var filteredData = []; // holds filtered data per parameters
      var chartdata = []; //this will hold chart data at any point of time
      var origin;
      var originby = 'Medal';  //default
      var originByVal;

      // Scene navigation logic
      var currentPage1 = "scene3.html";
      var nextPage1 = "scene3.html";
      var previousPage1 = "scene2.html";
      var summaryPage1 = "scene1.html";
      var medalsbyPage1 = "scene2.html";
      var medalsdetailPage= "scene3.html";

      function navigate(action) {
        if (action == "next") {
          dest = nextPage1;
        } else if (action == "previous") {
          dest = previousPage1;
        } else if (action == "summary") {
          dest = summaryPage1;
        } else if (action == "medalsby") {
          dest = medalsbyPage1;
        } else if (action == "medalsdetail") {
          dest = medalsdetailPage;
        } else dest = "#";
        window.location = dest;
      }

      // global JavaScript variables
      var list = [];
      var pageList = [];
      var currentPage = 1;
      var numberPerPage = 6;
      var numberOfPages = 1;   // calculates the total number of pages      

      function nextPage() {
        currentPage += 1;
        d3.select("svg").selectAll("*").remove(); 
        setTimeout(function(){ loadList(); }, 500);
      }

      function previousPage() {
        currentPage -= 1;
        d3.select("svg").selectAll("*").remove(); 
        setTimeout(function(){ loadList(); }, 500);
      }

      function firstPage() {
        currentPage = 1;
        d3.select("svg").selectAll("*").remove(); 
        setTimeout(function(){ loadList(); }, 500);
      }

      function lastPage() {
        currentPage = numberOfPages;
        d3.select("svg").selectAll("*").remove(); 
        setTimeout(function(){ loadList(); }, 500);
      }

      function getNumberOfPages() {
        return Math.ceil(list.length / numberPerPage);
      }      

      function loadList() {
        numberOfPages = getNumberOfPages();
        var begin = ((currentPage - 1) * numberPerPage);
        var end = begin + numberPerPage;

        pageList = list.slice(begin, end);
        chart(pageList); // draws out our data
        check();         // determines the states of the pagination buttons

        //set page number
        document.getElementById("paginationlabel").innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 
        "Total Years: <b>" + list.length + "</b>" + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 
          "Current Page: <b>" + currentPage + "</b>" + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + "Total Pages:<b>" + numberOfPages + "</b>";    
      } 
      
      function check() {
        document.getElementById("next").disabled = currentPage == numberOfPages ? true : false;
        document.getElementById("previous").disabled = currentPage == 1 ? true : false;
        document.getElementById("first").disabled = currentPage == 1 ? true : false;
        document.getElementById("last").disabled = currentPage == numberOfPages ? true : false;
      }      

      // All chart variables
      var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // The scale spacing the groups:
      var x0 = d3.scaleBand()
          .rangeRound([0, width])
          .paddingInner(0.1);

      // The scale for spacing each group's bar:
      var x1 = d3.scaleBand()
          .padding(0.05);

      var y = d3.scaleLinear()
        .rangeRound([height, 0]);   
        
      var z = d3.scaleOrdinal()    
        //.range(["steelblue", "darkorange", "green", "red", "purple", "brown", "pink"]);
		.range(["gold", "silver", "bronze"]);
		
      // Tool Tip mouse hover
      var tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("z-index", 10)
        .style("visibility", "hidden")
        .text("Simple text");

      //Function called on body onload
      async function init() {
        filedata = await d3.csv("data/Summer-Olympic-medals-1976-to-2008.csv");

		filedata = filedata.filter(function(d){return d.Medal && (d.Year >= 1976 && d.Year <= 2008);});
		
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        origin =
          urlParams.get("origin") == undefined ||
          urlParams.get("origin") == null ||
          urlParams.get("origin") == ""
            ? "All Countries"
            : urlParams.get("origin").replace('^', ' ').replace('~',' & ').replace('`', '+');
        originby =
          urlParams.get("originby") == undefined ||
          urlParams.get("originby") == null ||
          urlParams.get("originby") == ""
            ? "Sport"
            : urlParams.get("originby").replace('^', ' ').replace('~',' & ').replace('`', '+');
        originbyval =
          urlParams.get("originbyval") == undefined ||
          urlParams.get("originbyval") == null ||
          urlParams.get("originbyval") == ""
            ? ""
            : urlParams.get("originbyval").replace('^', ' ').replace('~',' & ').replace('`', '+');            

        //Before drawing chart set everything to blank
        var originbyval1 = (originbyval !== "")? originbyval : "All";
        document.getElementById("chartlabel").innerHTML = "<mark class='green'> Chart: </mark>" + 
          "Showing distribution for <mark class='teal'>" + origin + "</mark> by Game Type " + 
          "<mark class='teal'>" + originby + "</mark> - " + "<mark class='green'>" + originbyval1 + "</mark>" + "</br></br>";

        initializeChartData(); //initializes list with data for the next loadList call
        loadList();
      }


      //Function to form chart data depending on selection
      function initializeChartData() {
        var keyval;
        
        // first filter data by origin type
        if (originby === 'Discipline') {
          if (originbyval === '') {
            filteredData = filedata.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = filedata.filter(function(d){
              if ((d.Discipline == '-1') || (d.Discipline.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
			}
				//filter count
				else if(origin === 'All Countries'){
				    filteredData = filedata.filter(function(d){
					return d.Discipline == originbyval;
					});			
          } else {
            filteredData = filedata.filter(function(d){
			if (d.Country === origin)
			return d.Discipline == originbyval;});
          }
        }
        else if (originby === 'Sport') {
          if (originbyval === '') {
            filteredData = filedata.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = filedata.filter(function(d){
              if ((d.Sport == '-1') || (d.Sport.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
          } 
		  	//filter count
			else if(origin === 'All Countries'){
				    filteredData = filedata.filter(function(d){
					return d.Sport == originbyval;
					});			
          }
		  else {
            filteredData = filedata.filter(function(d){
			if (d.Country === origin)
			return d.Sport == originbyval;});
          }
        }

        // form chart data now
        var interimData, interimData1, interimData2, interimData3  = [];
        interimData = d3
        .nest()
        .key(function (d) {
          if (d["Year"] === "") keyval = "NA";
          else if (d["Year"] === "-1") keyval = "NA";
          else keyval = d["Year"].split('\n')[0]; //Removing linefeed and numbers at the end of medal category
          return keyval;
        })      
        .rollup(function (d) {
          return {
            gold: d3.sum(d, function (g) {
              if (g.Medal.toLowerCase() == 'gold') return 1;
              else return 0;
            }),
            silver: d3.sum(d, function (g) {
              if (g.Medal.toLowerCase() == 'silver') return 1;
              else return 0;
            }),
            bronze: d3.sum(d, function (g) {
              if (g.Medal.toLowerCase() == 'bronze') return 1;
              else return 0;
            }),
            totalmedalscount: d3.sum(d, function (g) {
                return 1;
            })
          }
        })
        .entries(filteredData);

        if((origin !== 'All Countries') && (origin !== ""))
          if (origin == 'Gold') interimData1 = interimData.slice().sort((a, b) => d3.ascending(a.key, b.key));
          else if (origin == 'Silver') interimData1 = interimData.slice().sort((a, b) => d3.ascending(a.key, b.key));
          else if (origin == 'Bronze') interimData1 = interimData.slice().sort((a, b) => d3.ascending(a.key, b.key)); 
          else interimData1 = interimData.slice().sort((a, b) => d3.ascending(a.value.key, b.value.key));         
        else
          interimData1 = interimData.slice().sort((a, b) => d3.ascending(a.key, b.key));

        var i = 0;   
        interimData2 = interimData1.map(function (obj) {
          return {
            key: obj.key,
            gold: obj.value.gold,
            silver: obj.value.silver,
            bronze: obj.value.bronze,
            totalmedalscount: obj.value.totalmedalscount
          }
        });
        list = [...interimData2];
      }      

      //Drawing the chart
      function chart(data) {
        console.log('Page Data', data);

        svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");        

        x0 = d3.scaleBand()
          .rangeRound([0, width])
          .paddingInner(0.1);

        // The scale for spacing each group's bar:
        x1 = d3.scaleBand()
          .padding(0.05);

        y = d3.scaleLinear()
        .rangeRound([height, 0]);   

        z = d3.scaleOrdinal()          
		.range(["gold", "silver", "bronze"]);
		
        var keys = ['gold' ,'silver', 'bronze'];

        x0.domain(data.map(function(d) { return d.key; }));
        x1.domain(keys).rangeRound([0, x0.bandwidth()]);
        y.domain([0, d3.max(data, function(d) { return d3.max(keys, function(key) { return d[key]; }); })]).nice();

        g.append("g")
            .selectAll("g")
            .data(data)
            .enter().append("g")
            .attr("class","bar")
            .attr("transform", function(d) { return "translate(" + x0(d.key) + ",0)"; })
            .selectAll("rect")
            .data(function(d) { return keys.map(function(key) { return {key: key, value: d[key]}; }); })
            .enter().append("rect")
            .attr("x", function(d) { return x1(d.key); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", x1.bandwidth())
            .attr("height", function(d) { return height - y(d.value); })
            .attr("fill", function(d) { return z(d.key); })
          .on("mouseover", function(d,i) {
            var selval = pageList[i];
            var textval = "";
            textval = d.key + " : " +  d.value
            tooltip.html(textval);
            return tooltip.style("visibility", "visible");
          })    
          .on("mousemove", function () {
            return tooltip
              .style("top", d3.event.pageY - 10 + "px")
              .style("left", d3.event.pageX + 10 + "px");
          })
          .on("mouseout", () => tooltip.style("visibility", "hidden"));            

        g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x0))
            .selectAll("text")
            .style("font-size", "12px");

        g.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(y).ticks(null, "s"))
            .append("text")
            .attr("x", 2)
            .attr("y", y(y.ticks().pop()) + 0.5)
            .attr("dy", "0.32em")
            .attr("font-size", 11)
            .attr("fill", "#000")
            //.attr("font-weight", "bold")
            .attr("text-anchor", "start")
            .text("Total Medal Count");

        var legend = g.append("g")
            .attr("font-family", "sans-serif")
            .attr("font-size", 12)
            .attr("text-anchor", "end")
            .selectAll("g")
            .data(keys.slice())
            .enter().append("g")
            .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

        legend.append("rect")
            .attr("x", width - 17)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", z)
            .attr("stroke", z)
            .attr("stroke-width",2)
            .on("click",function(d) { update(d) });

        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9.5)
            .attr("dy", "0.32em")
            .text(function(d) { return d; });

        var filtered = [];

        function update(d) {

          // Array update and clicked key addition if not included
            if (filtered.indexOf(d) == -1) {
                filtered.push(d);
                // if all bars are un-checked, reset:
                if(filtered.length == keys.length) filtered = [];
            }
            else {
                filtered.splice(filtered.indexOf(d), 1);
            }

            // Scale update group items
            var newKeys = [];
            keys.forEach(function(d) {
                if (filtered.indexOf(d) == -1 ) {
                    newKeys.push(d);
                }
            })
            x1.domain(newKeys).rangeRound([0, x0.bandwidth()]);
            y.domain([0, d3.max(data, function(d) { return d3.max(keys, function(key) { if (filtered.indexOf(key) == -1) return d[key]; }); })]).nice();

            // update y axis:
            svg.select(".y")
                .transition()
                .call(d3.axisLeft(y).ticks(null, "s"))
                .duration(500);

            //Hide bands if required
            var bars = svg.selectAll(".bar").selectAll("rect")
                .data(function(d) { return keys.map(function(key) { return {key: key, value: d[key]}; }); })

            bars.filter(function(d) {
                    return filtered.indexOf(d.key) > -1;
                })
                .transition()
                .attr("x", function(d) {
                    return (+d3.select(this).attr("x")) + (+d3.select(this).attr("width"))/2;
                })
                .attr("height",0)
                .attr("width",0)
                .attr("y", function(d) { return height; })
                .duration(500);

            // Bars adjustment
            bars.filter(function(d) {
                    return filtered.indexOf(d.key) == -1;
                })
                .transition()
                .attr("x", function(d) { return x1(d.key); })
                .attr("y", function(d) { return y(d.value); })
                .attr("height", function(d) { return height - y(d.value); })
                .attr("width", x1.bandwidth())
                .attr("fill", function(d) { return z(d.key); })
                .duration(500);


            // update filters
            legend.selectAll("rect")
                .transition()
                .attr("fill",function(d) {
                    if (filtered.length) {
                        if (filtered.indexOf(d) == -1) {
                            return z(d);
                        }
                        else {
                            return "white";
                        }
                    }
                    else {
                        return z(d);
                    }
                })
                .duration(100);
        }
      }
    </script>
  </body>
</html>
